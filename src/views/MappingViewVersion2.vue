<template>
  <div>
    <input type="file" @change="handleFileChange" accept="image/*" />
    <!-- Image Display -->
    <div v-if="imageUrl" style="position: relative; width: 70vw; height: auto">
      <img
        :src="imageUrl"
        alt="Uploaded Image"
        style="width: 100%; height: auto"
      />
      <!-- Canvas for Drawing Detections -->
      <canvas
        ref="imageCanvas"
        style="position: absolute; top: 0; left: 0"
      ></canvas>
    </div>
    <div v-if="identifications.length">
      <h3>Identifications:</h3>
      <ul>
        <li v-for="(id, index) in identifications" :key="index">{{ id }}</li>
      </ul>
    </div>
  </div>
</template>
<script setup lang="ts">
import { ref, onMounted, nextTick } from "vue";
import * as faceapi from "face-api.js";
import Person from "@/stores/types/Person";

const gallery: Person[] = [
  {
    name: "pim",
    descriptor: new Float32Array([
      -0.10710695385932922, 0.09120931476354599, 0.024193093180656433,
      -0.03404691815376282, -0.13814501464366913, -0.053053706884384155,
      -0.04612855985760689, -0.13488157093524933, 0.2103883922100067,
      -0.14071059226989746, 0.25032591819763184, -0.025829315185546875,
      -0.1671154797077179, -0.0816100686788559, -0.06757503747940063,
      0.20983855426311493, -0.22250805795192719, -0.127603679895401,
      -0.06001641973853111, 0.002331453375518322, 0.09296200424432755,
      -0.03249797597527504, 0.06344584375619888, 0.0748266875743866,
      -0.08752861618995667, -0.3892757296562195, -0.09906148165464401,
      -0.08683008700609207, -0.02889959327876568, -0.06505697965621948,
      -0.02771584689617157, 0.06321648508310318, -0.203733429312706,
      -0.07796210795640945, -0.031614404171705246, 0.032430604100227356,
      -0.035459939390420914, -0.08013814687728882, 0.17137733101844788,
      -0.021077847108244896, -0.2543351948261261, -0.003570318454876542,
      0.044498510658741, 0.2488047033548355, 0.1266806274652481,
      -0.006742669735103846, 0.037543799728155136, -0.14994436502456665,
      0.12091442942619324, -0.1481042355298996, -0.04087793454527855,
      0.14628320932388306, 0.04026747867465019, 0.028245970606803894,
      0.00586748355999589, -0.08870510756969452, 0.038886021822690964,
      0.08562730252742767, -0.08702784031629562, -0.006615700665861368,
      0.08299902826547623, -0.0661584660410881, -0.08138598501682281,
      -0.13665242493152618, 0.2610238492488861, 0.09617473185062408,
      -0.10438024252653122, -0.17451860010623932, 0.1085301861166954,
      -0.08996023237705231, -0.075830839574337, 0.0621039979159832,
      -0.17436093091964722, -0.2136106938123703, -0.2779178321361542,
      -0.04596465826034546, 0.389783650636673, 0.03540416434407234,
      -0.19798679649829865, 0.03462563827633858, -0.11160016059875488,
      0.014798897318542004, 0.11463440209627151, 0.1897091567516327,
      0.02540789544582367, 0.06853612512350082, -0.11364057660102844,
      0.02086879312992096, 0.21062888205051422, -0.11099130660295486,
      -0.0037188674323260784, 0.24886448681354523, 0.022287920117378235,
      0.05099433660507202, 0.011739982292056084, 0.02002139203250408,
      -0.08087530732154846, 0.07599181681871414, -0.16252176463603973,
      0.021996265277266502, 0.06116170063614845, -0.0027825837023556232,
      -0.05388280749320984, 0.03703612834215164, -0.12451204657554626,
      0.07815401256084442, 0.040860339999198914, 0.06163064390420914,
      0.05512993410229683, -0.03246806189417839, -0.13579188287258148,
      -0.12978464365005493, 0.11877184361219406, -0.20020805299282074,
      0.17929573357105255, 0.1644401252269745, 0.04357726499438286,
      0.1361030787229538, 0.09970812499523163, 0.11184485256671906,
      -0.059478841722011566, -0.0216824971139431, -0.2062828093767166,
      0.040459126234054565, 0.12511377036571503, -0.04292857274413109,
      0.003263570833951235, -0.04626626521348953,
    ]),
  },
  {
    name: "after",
    descriptor: new Float32Array([
      -0.09430861473083496, 0.04182859882712364, 0.026646194979548454,
      -0.05786168947815895, -0.09989403188228607, -0.020460208877921104,
      -0.09150376915931702, -0.11142498254776001, 0.18177075684070587,
      -0.16253454983234406, 0.24282142519950867, 0.020800847560167313,
      -0.22155530750751495, -0.08360034972429276, -0.06393939256668091,
      0.1647798866033554, -0.17891591787338257, -0.14742182195186615,
      -0.0430854894220829, -0.08341602981090546, 0.0023204716853797436,
      -0.0497870072722435, 0.06400348246097565, 0.026023579761385918,
      -0.07413647323846817, -0.3544776439666748, -0.1143231987953186,
      -0.0435236357152462, -0.0020319828763604164, -0.05711016803979874,
      -0.04574846476316452, 0.05529813840985298, -0.14301031827926636,
      -0.034468356519937515, 0.0033269510604441166, 0.13741886615753174,
      -0.028515441343188286, -0.06271935254335403, 0.20328772068023682,
      -0.02807735651731491, -0.19128203392028809, -0.05928501486778259,
      0.04840223863720894, 0.24892853200435638, 0.17113982141017914,
      0.032519593834877014, 0.04292190074920654, -0.07988875359296799,
      0.08579877763986588, -0.16382373869419098, 0.07420707494020462,
      0.12766101956367493, 0.1034344956278801, 0.024930428713560104,
      0.056442029774188995, -0.15485170483589172, 0.03290088474750519,
      0.14039646089076996, -0.03984896466135979, 0.012357563711702824,
      0.04947497695684433, -0.14882774651050568, -0.0014991213101893663,
      -0.031394265592098236, 0.2806655168533325, 0.11763884872198105,
      -0.11343371868133545, -0.1459396928548813, 0.14260907471179962,
      -0.11016284674406052, -0.08404401689767838, 0.03842627629637718,
      -0.15036851167678833, -0.16729268431663513, -0.35059255361557007,
      0.010395067743957043, 0.4452139437198639, 0.10725844651460648,
      -0.16164769232273102, 0.03769301623106003, -0.018582912161946297,
      -0.0030066492035984993, 0.1651517003774643, 0.18273252248764038,
      -0.09922764450311661, 0.031033111736178398, -0.1657627671957016,
      -0.0034807263873517513, 0.20764626562595367, -0.020420223474502563,
      -0.11967015266418457, 0.11744354665279388, -0.021318713203072548,
      0.1093195229768753, 0.06604250520467758, 0.05451693385839462,
      -0.06285618990659714, 0.027330251410603523, -0.1610432118177414,
      0.0010420640464872122, 0.06067826971411705, -0.05404246971011162,
      -0.03289036080241203, 0.08151789009571075, -0.08381693065166473,
      // eslint-disable-next-line @typescript-eslint/no-loss-of-precision
      0.030427932739257812, -0.001135564292781055, 0.014274513348937035,
      -0.007465509232133627, 0.02174375206232071, -0.1200924813747406,
      -0.08574695140123367, 0.12734682857990265, -0.23991712927818298,
      0.15754254162311554, 0.19305050373077393, 0.0490507036447525,
      0.19256669282913208, 0.167211651802063, 0.10584869980812073,
      -0.007479324005544186, -0.04305870831012726, -0.14261087775230408,
      -0.017489168792963028, 0.0277508907020092, 0.01794915273785591,
      0.14532683789730072, 0.04538100212812424,
    ]),
  },
  {
    name: "ajKob",
    descriptor: new Float32Array([
      -0.1439763605594635, 0.09503543376922607, 0.07364273816347122,
      -0.0683755949139595, -0.11453810334205627, -0.05753970518708229,
      -0.013790411874651909, -0.15300680696964264, 0.12309187650680542,
      -0.10034848749637604, 0.3551892638206482, -0.013120917603373528,
      -0.19694940745830536, -0.16744419932365417, -0.009050590917468071,
      0.16668257117271423, -0.18567495048046112, -0.08988582342863083,
      -0.1237252950668335, 0.03567185625433922, 0.05068708211183548,
      -0.04842744395136833, 0.08154235035181046, -0.01350212562829256,
      -0.006150001659989357, -0.4367532432079315, -0.13241629302501678,
      -0.045653048902750015, 0.00823921151459217, -0.03335193917155266,
      -0.04625508189201355, 0.028046168386936188, -0.2167389839887619,
      -0.10561688989400864, -0.016281254589557648, 0.03828005492687225,
      -0.012836363166570663, -0.05838679149746895, 0.1266067624092102,
      -0.041218873113393784, -0.2364073544740677, -0.000388296291930601,
      0.04892434924840927, 0.20031282305717468, 0.20080284774303436,
      0.09717551618814468, 0.03688638657331467, -0.10588748008012772,
      0.09205613285303116, -0.19705693423748016, 0.06953136622905731,
      0.11653608083724976, 0.10527440905570984, -0.019339459016919136,
      0.024166325107216835, -0.11837108433246613, 0.02112552523612976,
      0.1177857294678688, -0.09619729965925217, -0.02917547896504402,
      0.10709936171770096, -0.07454213500022888, -0.09514126181602478,
      -0.10411378741264343, 0.23326805233955383, 0.13277707993984222,
      -0.11600944399833679, -0.16013498604297638, 0.13841232657432556,
      -0.08188080042600632, -0.045434437692165375, 0.0300698634237051,
      -0.20908145606517792, -0.21504773199558258, -0.3043603003025055,
      0.0630974993109703, 0.40123313665390015, 0.10544371604919434,
      -0.20032216608524323, -0.033020686358213425, -0.11866071820259094,
      0.07132931798696518, 0.1034376323223114, 0.1192384585738182,
      -0.01935601979494095, -0.002605294808745384, -0.16784459352493286,
      -0.03420103341341019, 0.1801890730857849, -0.08946771919727325,
      -0.01743379607796669, 0.27471908926963806, -0.011910805478692055,
      0.05409181863069534, -0.01283007487654686, -0.00013945916725788265,
      -0.030441448092460632, 0.055898454040288925, -0.1555849313735962,
      0.006012751720845699, 0.0787602961063385, -0.0244121253490448,
      -0.050889745354652405, 0.1017286628484726, -0.15548986196517944,
      0.05758142098784447, -0.02623627334833145, 0.0796625018119812,
      0.07637767493724823, -0.10722464323043823, -0.043753717094659805,
      -0.12232004106044769, 0.07749973982572556, -0.18005195260047913,
      0.17684023082256317, 0.22451721131801605, 0.05132511630654335,
      0.13970667123794556, 0.1314544975757599, 0.10091094672679901,
      0.008457123301923275, -0.032520078122615814, -0.233247309923172,
      -0.001209316193126142, 0.10769043862819672, -0.03749270737171173,
      0.005168521776795387, -0.010343620553612709,
    ]),
  },
];

const imageUrl = ref<string | null>(null);
const identifications = ref<string[]>([]);
const imageCanvas = ref<HTMLCanvasElement | null>(null);

async function loadModels() {
  await Promise.all([
    faceapi.nets.ssdMobilenetv1.loadFromUri("/models"),
    faceapi.nets.faceLandmark68Net.loadFromUri("/models"),
    faceapi.nets.faceRecognitionNet.loadFromUri("/models"),
  ]);
}

onMounted(async () => {
  await loadModels();
});

const handleFileChange = async (event:any) => {
  const { files } = event.target;
  if (!files || !files.length) return;

  imageUrl.value = URL.createObjectURL(files[0]);
  await nextTick();

  const imageElement = new Image();
  imageElement.onload = async () => {
    if (imageCanvas.value) {
      const canvas = imageCanvas.value;
      canvas.width = imageElement.naturalWidth;
      canvas.height = imageElement.naturalHeight;


      // Adjust the canvas style to fit the image element in the container.
      canvas.style.width = '100%';
      canvas.style.height = 'auto';
      const ctx = canvas.getContext('2d');
      const displaySize = { width: canvas.width, height: canvas.height };
      faceapi.matchDimensions(canvas, displaySize);

      const detections = await faceapi.detectAllFaces(imageElement, new faceapi.SsdMobilenetv1Options())
        .withFaceLandmarks()
        .withFaceDescriptors();
      const resizedDetections = faceapi.resizeResults(detections, displaySize);

      // Clear the canvas
      ctx!.clearRect(0, 0, canvas.width, canvas.height);

      // Draw detections and landmarks
      faceapi.draw.drawDetections(canvas, resizedDetections);
      faceapi.draw.drawFaceLandmarks(canvas, resizedDetections);

      // Identification logic
      const identifiedNames = identifyFacesInScene(resizedDetections.map(det => det.descriptor));
      
      // Draw names near the detections
      identifiedNames.forEach((name, i) => {
        const box = resizedDetections[i].detection.box;
        const text = new faceapi.draw.DrawTextField(
          [`${name}`], // You might want to include additional info here
          { x: box.x, y: box.y - 10 }, // Position the text above the box
          {  fontSize: 50, fontStyle: 'Kanit' }
        );
        text.draw(canvas);
      });
    }
  };
  imageElement.src = imageUrl.value;
};


const identifyFacesInScene = (sceneDescriptors: Float32Array[]) => {
  const labeledFaceDescriptors = gallery.map(person =>
    new faceapi.LabeledFaceDescriptors(person.name, [person.descriptor])
  );
  const faceMatcher = new faceapi.FaceMatcher(labeledFaceDescriptors);
  //set identifications and persent to the user
    identifications.value = sceneDescriptors.map(descriptor => {
        const bestMatch = faceMatcher.findBestMatch(descriptor);
        return bestMatch.toString().split(' ')[0]; // Assuming the name is the first part of the string
    });
  return sceneDescriptors.map(descriptor => {
    const bestMatch = faceMatcher.findBestMatch(descriptor);
    return bestMatch.toString().split(' ')[0]; // Assuming the name is the first part of the string
  });
};

</script>
