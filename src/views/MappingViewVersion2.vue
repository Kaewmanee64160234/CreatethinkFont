<template>
  <div>
    <input type="file" @change="handleFileChange" accept="image/*" />
    <!-- Image Display -->
    <div v-if="imageUrl" style="position: relative; width: 70vw; height: auto">
      <img
        :src="imageUrl"
        alt="Uploaded Image"
        style="width: 100%; height: auto"
      />
      <!-- Canvas for Drawing Detections -->
      <canvas
        ref="imageCanvas"
        style="position: absolute; top: 0; left: 0"
      ></canvas>
    </div>
    <div v-if="identifications.length">
      <h3>Identifications:</h3>
      <ul>
        <li v-for="(id, index) in identifications" :key="index">{{ id }}</li>
      </ul>
    </div>
  </div>
</template>
<script setup lang="ts">
import { ref, onMounted, nextTick } from "vue";
import * as faceapi from "face-api.js";
import Person from "@/stores/types/Person";

const gallery: Person[] = [
  {
    name: "pim",
    descriptor: new Float32Array([
      -0.10710695385932922, 0.09120931476354599, 0.024193093180656433,
      -0.03404691815376282, -0.13814501464366913, -0.053053706884384155,
      -0.04612855985760689, -0.13488157093524933, 0.2103883922100067,
      -0.14071059226989746, 0.25032591819763184, -0.025829315185546875,
      -0.1671154797077179, -0.0816100686788559, -0.06757503747940063,
      0.20983855426311493, -0.22250805795192719, -0.127603679895401,
      -0.06001641973853111, 0.002331453375518322, 0.09296200424432755,
      -0.03249797597527504, 0.06344584375619888, 0.0748266875743866,
      -0.08752861618995667, -0.3892757296562195, -0.09906148165464401,
      -0.08683008700609207, -0.02889959327876568, -0.06505697965621948,
      -0.02771584689617157, 0.06321648508310318, -0.203733429312706,
      -0.07796210795640945, -0.031614404171705246, 0.032430604100227356,
      -0.035459939390420914, -0.08013814687728882, 0.17137733101844788,
      -0.021077847108244896, -0.2543351948261261, -0.003570318454876542,
      0.044498510658741, 0.2488047033548355, 0.1266806274652481,
      -0.006742669735103846, 0.037543799728155136, -0.14994436502456665,
      0.12091442942619324, -0.1481042355298996, -0.04087793454527855,
      0.14628320932388306, 0.04026747867465019, 0.028245970606803894,
      0.00586748355999589, -0.08870510756969452, 0.038886021822690964,
      0.08562730252742767, -0.08702784031629562, -0.006615700665861368,
      0.08299902826547623, -0.0661584660410881, -0.08138598501682281,
      -0.13665242493152618, 0.2610238492488861, 0.09617473185062408,
      -0.10438024252653122, -0.17451860010623932, 0.1085301861166954,
      -0.08996023237705231, -0.075830839574337, 0.0621039979159832,
      -0.17436093091964722, -0.2136106938123703, -0.2779178321361542,
      -0.04596465826034546, 0.389783650636673, 0.03540416434407234,
      -0.19798679649829865, 0.03462563827633858, -0.11160016059875488,
      0.014798897318542004, 0.11463440209627151, 0.1897091567516327,
      0.02540789544582367, 0.06853612512350082, -0.11364057660102844,
      0.02086879312992096, 0.21062888205051422, -0.11099130660295486,
      -0.0037188674323260784, 0.24886448681354523, 0.022287920117378235,
      0.05099433660507202, 0.011739982292056084, 0.02002139203250408,
      -0.08087530732154846, 0.07599181681871414, -0.16252176463603973,
      0.021996265277266502, 0.06116170063614845, -0.0027825837023556232,
      -0.05388280749320984, 0.03703612834215164, -0.12451204657554626,
      0.07815401256084442, 0.040860339999198914, 0.06163064390420914,
      0.05512993410229683, -0.03246806189417839, -0.13579188287258148,
      -0.12978464365005493, 0.11877184361219406, -0.20020805299282074,
      0.17929573357105255, 0.1644401252269745, 0.04357726499438286,
      0.1361030787229538, 0.09970812499523163, 0.11184485256671906,
      -0.059478841722011566, -0.0216824971139431, -0.2062828093767166,
      0.040459126234054565, 0.12511377036571503, -0.04292857274413109,
      0.003263570833951235, -0.04626626521348953,
    ]),
  },
  {
    name: "after",
    descriptor: new Float32Array([
      -0.09430861473083496, 0.04182859882712364, 0.026646194979548454,
      -0.05786168947815895, -0.09989403188228607, -0.020460208877921104,
      -0.09150376915931702, -0.11142498254776001, 0.18177075684070587,
      -0.16253454983234406, 0.24282142519950867, 0.020800847560167313,
      -0.22155530750751495, -0.08360034972429276, -0.06393939256668091,
      0.1647798866033554, -0.17891591787338257, -0.14742182195186615,
      -0.0430854894220829, -0.08341602981090546, 0.0023204716853797436,
      -0.0497870072722435, 0.06400348246097565, 0.026023579761385918,
      -0.07413647323846817, -0.3544776439666748, -0.1143231987953186,
      -0.0435236357152462, -0.0020319828763604164, -0.05711016803979874,
      -0.04574846476316452, 0.05529813840985298, -0.14301031827926636,
      -0.034468356519937515, 0.0033269510604441166, 0.13741886615753174,
      -0.028515441343188286, -0.06271935254335403, 0.20328772068023682,
      -0.02807735651731491, -0.19128203392028809, -0.05928501486778259,
      0.04840223863720894, 0.24892853200435638, 0.17113982141017914,
      0.032519593834877014, 0.04292190074920654, -0.07988875359296799,
      0.08579877763986588, -0.16382373869419098, 0.07420707494020462,
      0.12766101956367493, 0.1034344956278801, 0.024930428713560104,
      0.056442029774188995, -0.15485170483589172, 0.03290088474750519,
      0.14039646089076996, -0.03984896466135979, 0.012357563711702824,
      0.04947497695684433, -0.14882774651050568, -0.0014991213101893663,
      -0.031394265592098236, 0.2806655168533325, 0.11763884872198105,
      -0.11343371868133545, -0.1459396928548813, 0.14260907471179962,
      -0.11016284674406052, -0.08404401689767838, 0.03842627629637718,
      -0.15036851167678833, -0.16729268431663513, -0.35059255361557007,
      0.010395067743957043, 0.4452139437198639, 0.10725844651460648,
      -0.16164769232273102, 0.03769301623106003, -0.018582912161946297,
      -0.0030066492035984993, 0.1651517003774643, 0.18273252248764038,
      -0.09922764450311661, 0.031033111736178398, -0.1657627671957016,
      -0.0034807263873517513, 0.20764626562595367, -0.020420223474502563,
      -0.11967015266418457, 0.11744354665279388, -0.021318713203072548,
      0.1093195229768753, 0.06604250520467758, 0.05451693385839462,
      -0.06285618990659714, 0.027330251410603523, -0.1610432118177414,
      0.0010420640464872122, 0.06067826971411705, -0.05404246971011162,
      -0.03289036080241203, 0.08151789009571075, -0.08381693065166473,
      // eslint-disable-next-line @typescript-eslint/no-loss-of-precision
      0.030427932739257812, -0.001135564292781055, 0.014274513348937035,
      -0.007465509232133627, 0.02174375206232071, -0.1200924813747406,
      -0.08574695140123367, 0.12734682857990265, -0.23991712927818298,
      0.15754254162311554, 0.19305050373077393, 0.0490507036447525,
      0.19256669282913208, 0.167211651802063, 0.10584869980812073,
      -0.007479324005544186, -0.04305870831012726, -0.14261087775230408,
      -0.017489168792963028, 0.0277508907020092, 0.01794915273785591,
      0.14532683789730072, 0.04538100212812424,
    ]),
  },
  {
    name: "ajKob",
    descriptor: new Float32Array([
      -0.1439763605594635, 0.09503543376922607, 0.07364273816347122,
      -0.0683755949139595, -0.11453810334205627, -0.05753970518708229,
      -0.013790411874651909, -0.15300680696964264, 0.12309187650680542,
      -0.10034848749637604, 0.3551892638206482, -0.013120917603373528,
      -0.19694940745830536, -0.16744419932365417, -0.009050590917468071,
      0.16668257117271423, -0.18567495048046112, -0.08988582342863083,
      -0.1237252950668335, 0.03567185625433922, 0.05068708211183548,
      -0.04842744395136833, 0.08154235035181046, -0.01350212562829256,
      -0.006150001659989357, -0.4367532432079315, -0.13241629302501678,
      -0.045653048902750015, 0.00823921151459217, -0.03335193917155266,
      -0.04625508189201355, 0.028046168386936188, -0.2167389839887619,
      -0.10561688989400864, -0.016281254589557648, 0.03828005492687225,
      -0.012836363166570663, -0.05838679149746895, 0.1266067624092102,
      -0.041218873113393784, -0.2364073544740677, -0.000388296291930601,
      0.04892434924840927, 0.20031282305717468, 0.20080284774303436,
      0.09717551618814468, 0.03688638657331467, -0.10588748008012772,
      0.09205613285303116, -0.19705693423748016, 0.06953136622905731,
      0.11653608083724976, 0.10527440905570984, -0.019339459016919136,
      0.024166325107216835, -0.11837108433246613, 0.02112552523612976,
      0.1177857294678688, -0.09619729965925217, -0.02917547896504402,
      0.10709936171770096, -0.07454213500022888, -0.09514126181602478,
      -0.10411378741264343, 0.23326805233955383, 0.13277707993984222,
      -0.11600944399833679, -0.16013498604297638, 0.13841232657432556,
      -0.08188080042600632, -0.045434437692165375, 0.0300698634237051,
      -0.20908145606517792, -0.21504773199558258, -0.3043603003025055,
      0.0630974993109703, 0.40123313665390015, 0.10544371604919434,
      -0.20032216608524323, -0.033020686358213425, -0.11866071820259094,
      0.07132931798696518, 0.1034376323223114, 0.1192384585738182,
      -0.01935601979494095, -0.002605294808745384, -0.16784459352493286,
      -0.03420103341341019, 0.1801890730857849, -0.08946771919727325,
      -0.01743379607796669, 0.27471908926963806, -0.011910805478692055,
      0.05409181863069534, -0.01283007487654686, -0.00013945916725788265,
      -0.030441448092460632, 0.055898454040288925, -0.1555849313735962,
      0.006012751720845699, 0.0787602961063385, -0.0244121253490448,
      -0.050889745354652405, 0.1017286628484726, -0.15548986196517944,
      0.05758142098784447, -0.02623627334833145, 0.0796625018119812,
      0.07637767493724823, -0.10722464323043823, -0.043753717094659805,
      -0.12232004106044769, 0.07749973982572556, -0.18005195260047913,
      0.17684023082256317, 0.22451721131801605, 0.05132511630654335,
      0.13970667123794556, 0.1314544975757599, 0.10091094672679901,
      0.008457123301923275, -0.032520078122615814, -0.233247309923172,
      -0.001209316193126142, 0.10769043862819672, -0.03749270737171173,
      0.005168521776795387, -0.010343620553612709,
    ]),
  },
  {
    name: "cream",
    descriptor: new Float32Array([
      -0.11763368546962738, 0.1381583958864212, 0.11323162168264389,
      -0.06214823201298714, -0.13676650822162628, -0.012930036522448063,
      -0.085398368537426, -0.13265569508075714, 0.15105943381786346,
      -0.16794058680534363, 0.31464463472366333, -0.0909893810749054,
      -0.25984132289886475, -0.10826420783996582, -0.026421144604682922,
      0.22555463016033173, -0.15357927978038788, -0.12104396522045135,
      -0.0545225627720356, -0.005895940121263266, 0.057095520198345184,
      -0.031854528933763504, 0.06281240284442902, 0.07138697803020477,
      -0.08897297084331512, -0.42307615280151367, -0.06444832682609558,
      -0.06472252309322357, -0.04843053221702576, -0.05891299992799759,
      -0.08743497729301453, 0.06113152205944061, -0.1967526078224182,
      -0.04433310776948929, -0.015613257884979248, 0.07562655210494995,
      -0.043959248811006546, -0.08157403022050858, 0.18341167271137238,
      -0.05161898583173752, -0.26717668771743774, 0.015299216844141483,
      0.0326540507376194, 0.20964102447032928, 0.14285250008106232,
      0.037638209760189056, 0.051278866827487946, -0.13119645416736603,
      0.11934728175401688, -0.15425153076648712, 0.022754181176424026,
      0.19200803339481354, 0.05946989730000496, 0.0026425726246088743,
      0.01191167626529932, -0.12753647565841675, -0.04519674926996231,
      0.12752218544483185, -0.09500101208686829, -0.06051686406135559,
      0.06936251372098923, -0.08858969807624817, -0.061740487813949585,
      -0.22735083103179932, 0.27695631980895996, 0.12635953724384308,
      -0.13810613751411438, -0.15772470831871033, 0.1386401653289795,
      -0.09812205284833908, -0.05931318551301956, 0.03509201854467392,
      -0.21467719972133636, -0.1872391402721405, -0.28488707542419434,
      0.031140582635998726, 0.29090607166290283, 0.08462629467248917,
      -0.1790696233510971, 0.04016596078872681, -0.0705857127904892,
      0.014221682213246822, 0.021013880148530006, 0.2066316455602646,
      0.03516625240445137, 0.055851276963949203, -0.023527422919869423,
      -0.021928803995251656, 0.19215835630893707, -0.12049572914838791,
      0.036300934851169586, 0.2538702189922333, -0.019014548510313034,
      0.03169386833906174, -0.016054116189479828, -0.062178146094083786,
      -0.0977097749710083, 0.01655523106455803, -0.1433350294828415,
      0.034835636615753174, -0.04987518861889839, -0.042451366782188416,
      -0.030290856957435608, 0.045385077595710754, -0.1983371376991272,
      0.06155311316251755, -0.019074294716119766, 0.031182998791337013,
      0.04380764812231064, -0.016090882942080498, -0.08321639150381088,
      -0.15132422745227814, 0.12068706750869751, -0.2284841686487198,
      0.18970133364200592, 0.17698761820793152, 0.09497594088315964,
      0.1607091873884201, 0.1395368129014969, 0.1421847641468048,
      -0.00032466943957842886, 0.009474355727434158, -0.18526874482631683,
      -0.015533355996012688, 0.16824857890605927, -0.05699022859334946,
      0.029948469251394272, -0.021143538877367973,
    ]),
  },
  {
    name: "toey",
    descriptor: new Float32Array([
      -0.09441986680030823, 0.021994100883603096, 0.02433912828564644,
      -0.06464385986328125, -0.07549025863409042, -0.06735651940107346,
      -0.018108801916241646, -0.15328264236450195, 0.20860736072063446,
      -0.14642980694770813, 0.2638152539730072, -0.014765040017664433,
      -0.20309783518314362, -0.07873227447271347, 0.00911412201821804,
      0.16544882953166962, -0.18896731734275818, -0.1271512508392334,
      -0.014250051230192184, -0.07433731853961945, 0.05067671462893486,
      -0.04987507686018944, 0.09800078719854355, 0.12433791160583496,
      -0.14627429842948914, -0.3269656002521515, -0.14277219772338867,
      -0.23080238699913025, -0.02470318414270878, -0.019685102626681328,
      -0.02864096313714981, 0.08889852464199066, -0.17868778109550476,
      -0.04061243683099747, -0.0069382633082568645, 0.0542169027030468,
      0.014513994567096233, -0.06165927276015282, 0.2183186560869217,
      -0.0164067093282938, -0.2209189236164093, -0.13265545666217804,
      0.01880367286503315, 0.20101910829544067, 0.13631954789161682,
      -0.009879980236291885, 0.05017527565360069, -0.03762830048799515,
      0.07621897757053375, -0.13299429416656494, 0.02156173065304756,
      0.08796829730272293, 0.06778636574745178, -0.004347916692495346,
      -0.001573637593537569, -0.1652982383966446, 0.0423632375895977,
      0.05778280273079872, -0.17563438415527344, -0.050288911908864975,
      0.053941722959280014, -0.1288074553012848, -0.08053549379110336,
      -0.04419955983757973, 0.31707963347435, 0.14919988811016083,
      -0.11695841699838638, -0.11816509813070297, 0.20238834619522095,
      -0.14052125811576843, -0.02172781154513359, 0.07456155866384506,
      -0.23069122433662415, -0.1561330258846283, -0.2835271656513214,
      -0.044316526502370834, 0.4598447382450104, 0.02644648402929306,
      -0.12870629131793976, 0.036548513919115067, -0.13238196074962616,
      -0.010755306109786034, 0.07445656508207321, 0.14152608811855316,
      -0.004866763949394226, 0.07383713871240616, -0.07857799530029297,
      0.011197292245924473, 0.18094490468502045, -0.08433108776807785,
      -0.027283119037747383, 0.15365387499332428, -0.06137681007385254,
      0.04795655235648155, 0.05469586327672005, -0.013030788861215115,
      -0.03822437673807144, -0.007231463678181171, -0.12897926568984985,
      0.049674149602651596, -0.07406757026910782, -0.04729337990283966,
      -0.06339512765407562, 0.04934979975223541, -0.1842050403356552,
      0.025715725496411324, 0.04306545481085777, -0.07501430809497833,
      -0.06060877814888954, -0.007315203081816435, -0.1504317671060562,
      -0.12684325873851776, 0.15775230526924133, -0.23037390410900116,
      0.1292649209499359, 0.16953034698963165, 0.04465905576944351,
      0.18202024698257446, 0.02367524616420269, 0.10042719542980194,
      -0.07305703312158585, -0.052486859261989594, -0.23737840354442596,
      0.019347090274095535, 0.13004998862743378, -0.05248023569583893,
      0.055407844483852386, -0.032776135951280594,
    ]),
  },
  {
    name: "minnie",
    descriptor: new Float32Array([
      -0.06993574649095535, -0.010046405717730522, 0.04713976010680199,
      -0.09890789538621902, -0.1510644406080246, -0.09167298674583435,
      -0.0057283081114292145, -0.05213182047009468, 0.113599993288517,
      -0.06403450667858124, 0.1788410246372223, -0.08238878101110458,
      -0.2734346091747284, -0.052851855754852295, -0.039870355278253555,
      0.0900334045290947, -0.08946841955184937, -0.08654935657978058,
      -0.14455345273017883, -0.13085448741912842, 0.019131427630782127,
      0.01753053069114685, -0.006509753875434399, -0.0030457729008048773,
      // eslint-disable-next-line @typescript-eslint/no-loss-of-precision
      -0.10287471115589142, -0.20975112915039062, -0.0789070799946785,
      -0.07429135590791702, 0.10498166084289551, -0.0824543908238411,
      0.016231805086135864, 0.13141797482967377, -0.18060725927352905,
      -0.07153536379337311, 0.014436897821724415, 0.05662691965699196,
      -0.08986201882362366, -0.10457738488912582, 0.21518783271312714,
      -0.088692307472229, -0.18597917258739471, -0.030838966369628906,
      0.07897535711526871, 0.19461414217948914, 0.19057798385620117,
      -0.027182074263691902, 0.016285646706819534, -0.03228626027703285,
      0.06906993687152863, -0.25934070348739624, -0.020883824676275253,
      0.21541783213615417, 0.1110898107290268, 0.11059430986642838,
      0.07895056158304214, -0.13690303266048431, 0.027271805331110954,
      0.19148260354995728, -0.17493543028831482, 0.07594242691993713,
      0.029350098222494125, -0.09586279839277267, -0.05718497559428215,
      -0.15201374888420105, 0.18619605898857117, 0.07564423233270645,
      -0.12050153315067291, -0.21189412474632263, 0.1995164006948471,
      -0.19922807812690735, -0.08702380955219269, 0.15524998307228088,
      -0.1161252111196518, -0.1478073000907898, -0.22380103170871735,
      0.019098088145256042, 0.3211435079574585, 0.17707358300685883,
      -0.12651142477989197, 0.06609081476926804, -0.11963869631290436,
      -0.08989755064249039, -0.03238947317004204, -0.00755899865180254,
      -0.05564101040363312, -0.021541718393564224, -0.054917022585868835,
      -0.005980611778795719, 0.22157059609889984, -0.08340606838464737,
      0.014870830811560154, 0.19971871376037598, 0.024628084152936935,
      -0.016295019537210464, -0.051096148788928986, -0.017908280715346336,
      -0.09680244326591492, 0.0010276198154315352, -0.07906530052423477,
      -0.0019886356312781572, 0.09217581897974014, -0.1950247585773468,
      0.04122312739491463, 0.10808505862951279, -0.1575125902891159,
      0.18384674191474915, -0.030314886942505836, 0.01572483219206333,
      -0.021363064646720886, -0.016947679221630096, -0.06369028985500336,
      0.02908751182258129, 0.21251355111598969, -0.2534937560558319,
      0.272192120552063, 0.17998352646827698, 0.07328066229820251,
      0.08348728716373444, 0.09134893119335175, 0.07580498605966568,
      0.011458524502813816, -0.0338788740336895, -0.13527800142765045,
      -0.12188706547021866, 0.024599676951766014, -0.06608328223228455,
      0.014384458772838116, 0.06882110238075256,
    ]),
  },
];

const imageUrl = ref<string | null>(null);
const identifications = ref<string[]>([]);
const imageCanvas = ref<HTMLCanvasElement | null>(null);

async function loadModels() {
  await Promise.all([
    faceapi.nets.ssdMobilenetv1.loadFromUri("/models"),
    faceapi.nets.faceLandmark68Net.loadFromUri("/models"),
    faceapi.nets.faceRecognitionNet.loadFromUri("/models"),
  ]);
}

onMounted(async () => {
  await loadModels();
});

const handleFileChange = async (event: any) => {
  const { files } = event.target;
  if (!files || !files.length) return;

  imageUrl.value = URL.createObjectURL(files[0]);
  await nextTick();

  const imageElement = new Image();
  imageElement.onload = async () => {
    if (imageCanvas.value) {
      const canvas = imageCanvas.value;
      canvas.width = imageElement.naturalWidth;
      canvas.height = imageElement.naturalHeight;

      // Adjust the canvas style to fit the image element in the container.
      canvas.style.width = "100%";
      canvas.style.height = "auto";
      const ctx = canvas.getContext("2d");
      const displaySize = { width: canvas.width, height: canvas.height };
      faceapi.matchDimensions(canvas, displaySize);

      const detections = await faceapi
        .detectAllFaces(imageElement, new faceapi.SsdMobilenetv1Options())
        .withFaceLandmarks()
        .withFaceDescriptors();
      const resizedDetections = faceapi.resizeResults(detections, displaySize);

      // Clear the canvas
      ctx!.clearRect(0, 0, canvas.width, canvas.height);

      // Draw detections and landmarks
      faceapi.draw.drawDetections(canvas, resizedDetections);
      faceapi.draw.drawFaceLandmarks(canvas, resizedDetections);

      // Identification logic
      const identifiedNames = identifyFacesInScene(
        resizedDetections.map((det) => det.descriptor)
      );

      // Draw names near the detections
      identifiedNames.forEach((name, i) => {
        const box = resizedDetections[i].detection.box;
        const text = new faceapi.draw.DrawTextField(
          [`${name}`], // You might want to include additional info here
          { x: box.x, y: box.y - 10 }, // Position the text above the box
          { fontSize: 14, fontStyle: "Kanit" }
        );
        text.draw(canvas);
      });
    }
  };
  imageElement.src = imageUrl.value;
};

const identifyFacesInScene = (sceneDescriptors: Float32Array[]) => {
  const labeledFaceDescriptors = gallery.map(
    (person) =>
      new faceapi.LabeledFaceDescriptors(person.name, [person.descriptor])
  );
  const faceMatcher = new faceapi.FaceMatcher(labeledFaceDescriptors);
  //set identifications and persent to the user
  identifications.value = sceneDescriptors.map((descriptor) => {
    const bestMatch = faceMatcher.findBestMatch(descriptor);
    return bestMatch.toString().split(" ")[0]; // Assuming the name is the first part of the string
  });
  return sceneDescriptors.map((descriptor) => {
    const bestMatch = faceMatcher.findBestMatch(descriptor);
    return bestMatch.toString().split(" ")[0]; // Assuming the name is the first part of the string
  });
};
</script>
